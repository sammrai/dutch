<html>
   <head>
      <!-- Standard Meta -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
      <title>dutch</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.3/semantic.min.css"/>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.3/semantic.min.js"></script>
      <style>
         /*設定バー*/
        .candidacy_one{
          margin: 1em;
        }
         .cost_stacker > span > .label{
         margin-bottom: 4px !important;
         }
         .cost_stacker {
          text-align: left;
         }
         .summary td:nth-child(1){
         font-weight: bold;
         }
         .summary td:nth-child(2){
         text-align: right !important;
         }
         .summary { border: 0px !important; 
         padding: 1em !important;
         margin: 0em !important;
         padding-top: 0em !important;
         padding-bottom: 0.5em !important;

         }
         .ui.summary tr td { border-top: 0px !important; 
         padding-bottom: 0.1em;
         padding-top: 0.1em;
         margin-bottom: 0px !important;
         }
         .barloading {
         overflow: hidden!important;
         }
         .barloading::after {
         opacity: 0.9;
         width: 60%;
         height: 5px;
         content: '';
         left: 0;
         bottom: 0;
         background: #00B5AD;
         transition: linear;
         position: absolute;
         -webkit-animation: mymove calc(1s);
         /* Safari 4.0 - 8.0 */
         -webkit-animation-iteration-count: infinite;
         /* Safari 4.0 - 8.0 */
         -webkit-animation-timing-function: linear;
         /* Safari 4.0 - 8.0 */
         animation-duration: mymove 1s;
         animation-iteration-count: infinite;
         animation-timing-function: linear;
         }
         @-webkit-keyframes mymove {
         from {
         left: -60%;
         }
         to {
         left: 130%;
         }
         }
         @keyframes mymove {
         from {
         left: -60%;
         }
         to {
         left: 130%;
         }
         }
         .ui.container.main {
         margin: 3em;
         }
         #sum{
         color: teal;
         font-size: 150%;
         }
         .cost_stacker > span{
         margin-right: 0.5em
         }
         .chart {
         white-space: nowrap;
          text-align: left;

         margin: 0;
         margin-bottom: 1em;
         padding: 0;
         }

         .bar {
         display: inline-block;
         white-space: nowrap;
         background-color: #00B5AD;
         height: 3px;
         border-radius: 2px;
         margin-right: 2px
         }

         #summary_board{
            /*overflow: hidden!important;*/
            /*height: 180px*/
            padding-bottom: 2em;
        }
        
        .summary_card{
          padding-bottom: 1.5em; 
          padding-top: 1.5em; 
          }

          #showcandidacy{
            color: white;
          }

          .cost_stacker > .item > .label{
            overflow: hidden;
            padding-bottom: 0.2em;
            padding-top: 0.2em;
          }
          .cost_stacker.help{
            text-align: right;
          }
          #share{
            margin-top: 1em;
            text-align: center;
          }

      </style>
   </head>
   <div class="ui content">
   <nav class="ui borderless menu" style="height: 5em !important;">
      <div class="ui container">
         <!--    <div class="item">
            <img src="icon.png">
            </div> -->
         <div class="item">
            <h1>warican</h1>
         </div>
         <a class="item active">傾斜割り勘</a>
         <div class="right menu">
            <a class="item" id="loading" style="visibility: hidden;">
               <div class="ui tiny active inline loader"></div>
            </a>
         </div>
      </div>
   </nav>
   <div class="ui container main">
      <div class="ui grid stackable container">
         <div class="eight wide column calc">
            <form class="ui form">
               <div class="field">
                  <label>金額</label>
                  <div class="ui labeled input">
                     <div class="ui label">
                        ¥
                     </div>
                     <input type="number" placeholder="12000" id="charge" value="12000" >
                  </div>
               </div>
               <div class="field">
                  <label>人数</label>
                  <!-- <input type="text" name="last-name" placeholder="Last Name"> -->
                  <div class="ui fluid multiple search selection dropdown" id="member">
                     <input name="tags" type="hidden" value="2,8" onclick="this.select(0,this.value.length)">
                     <i class="dropdown icon"></i>
                     <div class="default text">5</div>
                     <div class="menu left transition hidden" tabindex="-1">
                        <div class="item" data-value="0">0</div>
                        <div class="item" data-value="1">1</div>
                        <div class="item" data-value="2">2</div>
                        <div class="item" data-value="3">3</div>
                        <div class="item" data-value="4">4</div>
                        <div class="item" data-value="5">5</div>
                        <div class="item" data-value="6">6</div>
                        <div class="item" data-value="7">7</div>
                        <div class="item" data-value="8">8</div>
                        <div class="item" data-value="9">9</div>
                     </div>
                  </div>
               </div>
               <div class="ui accordion field">
                  <div class="title ">
                     <i class="icon dropdown"></i> 高度な設定
                  </div>
                  <div class="content field ">
                     <div class="field">
                        <label>最小単位</label>
                        <div class="fluid ui buttons selection" id="digit">
                           <p class="ui button active teal" digit-value="0">指定なし</p>
                           <p class="ui button" digit-value="3">1000</p>
                           <p class="ui button" digit-value="2">100</p>
                        </div>
                     </div>
                     <!-- <div class="field">
                        <label>赤字</label>
                        <div class="fluid ui buttons selection" id="positive">
                           <p class="ui button active teal" positive-flag="1">許容</p>
                           <p class="ui button" positive-flag="0">許容しない</p>
                        </div>
                     </div> -->
                     <div class="field">
                        <label>傾斜の強さ</label>
                        <div class="fluid ui buttons selection" id="grad">
                           <p class="ui button active teal" grad-value="1">弱い</p>
                           <p class="ui button" grad-value="2">普通</p>
                           <p class="ui button" grad-value="4">強い</p>
                        </div>
                     </div>
                  </div>
               </div>
               <p class="ui button teal fluid" id="exec">計算</p>
               <!-- <button class="ui button" type="exec">exec</button> -->
               
            </form>
                   </div>
                   <div class="eight wide column">
                    <div class="ui negative message" hidden id="error">
            <div class="header">
              エラー
            </div>
            <p>ネットワークに接続できません。またはAPIが一時的に利用できない状態にあります。
          </p></div>


<div class="cost_stacker help"><span class="item"><div class="ui gray image label">人数<div class="detail">一人あたり支払額</div></div></span></div>

            <div class="ui segment" id="summary_board"><div class="summary_card"><div class="cost_stacker"><span class="item"><div class="ui teal image label" data-num="0" >2<div class="detail">¥ 2,000</div></div></span><span class="item"><div class="ui teal image label" data-num="1" style="opacity: 0.5;">8<div class="detail">¥ 1,000</div></div></span></div><table class="ui very basic table unstackable summary">
                  <thead>
                     
                  </thead>
                  <tbody>
                     <tr>
                        <td>
                           合計
                        </td><td id="sum" class="ui teal">¥ 12,000</td>
                     </tr>
                     <tr>
                        <td>
                           差額
                        </td><td id="balance">¥ 0</td>
                     </tr>
                  </tbody>
               </table><div class="chart"><div class="bar" data-num="0" data-content="¥ 4,000" style="width: 33.3333%; opacity: 1;"></div><div class="bar" data-num="1" data-content="¥ 8,000" style="width: 66.6667%; opacity: 0.5;"></div></div></div><div class="ui center aligned grid">

           </div>

         </div>
      </div>

      <div id="result-table"></div>
      <!-- <div class="ui segment" id="send" style="word-wrap:break-word;"></div> -->
      <!-- <div class="ui segment" id="ret" style="word-wrap:break-word;"></div> -->
   </div>


   </body>
</html>
<script type="text/javascript">
   $(".selection > .button").click(function () {
  $(this).siblings().each(function () {
    $(this).removeClass("active");
    $(this).removeClass("teal");
  })
  $(this).addClass("teal")
  $(this).addClass("active")
});

function dot(a, b) {
  var ret = 0;
  for (i = 0; i < a.length; i++) {
    ret += a[i] * b[i];
  }
  return ret
}

function localestr(sum0){
  sum0 = sum0.toLocaleString();
  return "¥ " + sum0;
}

function makecard(member,coef,charge,balance){
  var summary_card = $('<div class="summary_card">');

  var cost_stacker = $('<div class="cost_stacker">')
      var chart_container = $('<div class="chart">')
      $.each(member, function (i, e){
          // コストスタックを再描画
          var opacity = -(i/(member.length-1))*0.5+1
          var stack_one=$('<span class="item">');
          var stack_label = $('<div class="ui teal image label">');
          stack_label.attr("data-num",i)
          stack_label.text(member[i]);
          var stack_charge= $('<div class="detail">');
          stack_charge.text(localestr(coef[i]));
          stack_label.css('opacity', opacity);
          stack_label.append(stack_charge);
          stack_label.appendTo(stack_one);
          stack_one.appendTo(cost_stacker)

          // 合計・差額を再描画
          var bar_one = $('<div class="bar">');
          bar_one.attr("data-num",i)
          bar_one.width(coef[i]*member[i]/charge*100+"%");
          bar_one.css('opacity', opacity);
          bar_one.attr("data-content",localestr(coef[i]*member[i]))
          bar_one.appendTo(chart_container)

          // $("#summary_board > .cost_stacker > span > .label[data-num="+i+"]")
          stack_label
          .popup({
            position : 'top center',
            target   : bar_one,
            content  : bar_one.attr("data-content")
          });

         
      })

      // 合計と差額の再描画
      var sum0 = dot(coef, member)
      var dom=($(` <table class="ui very basic table unstackable summary">
                  <thead>
                     </tr>
                  </thead>
                  <tbody>
                     <tr>
                        <td>
                           合計
                        <td id="sum" class="ui teal">
                           ¥ 12,000
                        </td>
                     </tr>
                     <tr>
                        <td>
                           差額
                        <td id="balance">
                           ¥ 0
                        </td>
                     </tr>
                  </tbody>
               </table>`))

      dom.find("#sum").text(localestr(sum0));
      var balance = balance;
      dom.find("#balance").text(localestr(-balance));
      dom.find("#balance").removeClass("positive");
      if (balance > 0) {
        dom.find("#balance").addClass("negative")
          var bar_one = $('<div class="bar">');
          bar_one.width(balance/charge*100+"%");
          // console.log(balance/charge*100)
          bar_one.css("background-color","red");
          bar_one.attr("data-content",localestr(-balance))
          bar_one.appendTo(chart_container)
      } else {
        dom.find("#balance").removeClass("negative");
      }
      summary_card.append(cost_stacker)
      summary_card.append(dom)
      summary_card.append(chart_container)
      return summary_card;
}

$('#member')
  .dropdown({
    allowAdditions: true
  });

$('#exec').click(function () {
  $("#summary_board").addClass("loading")

  var members = [];
  $("#member a").each(function (i) {
    members.push(Number($(this).attr("data-value")));
  });
  var data = {
    "charge": Number($("#charge").val()),
    "members": members,
    "candidacy": true
  }
  var digit = $("#digit > p.ui.button.active").attr("digit-value");
  if (digit != 0) data["digit"] = Number(digit)
  if ($("#positive > p.ui.button.active").attr("positive-flag") == 0) data["force_positive"] = true;
  data["grad"] = Number($("#grad > p.ui.button.active").attr("grad-value"));


  $.ajax({
    type: "post",
    url: "https://7011q14uo8.execute-api.ap-northeast-1.amazonaws.com/default/dutch",
    data: JSON.stringify(data),
    contentType: 'application/json',
    dataType: "json",
    success: function (json_data) {

      $("#summary_board").empty()

      $.each(json_data["candidacy"]["coefs"],function(i,e){
         var card = makecard(json_data["members"],json_data["candidacy"]["coefs"][i],json_data["charge"],json_data["candidacy"]["intercepts"][i],)
         // card.opacity
        // if (i==1)$("#summary_board").append($('<div class="ui divider"></div>'))
        if (i==1){
          var cadbutton = $(`
            <div class="ui center aligned grid">
                 <div class="column">
                    <a class="ui tiny button gray" id="showcandidacy" openflag="1">候補を表示</a>
                 </div>
               </div>
            `)
          $("#summary_board").append(cadbutton)
          $("#showcandidacy").click(function(){
            $(".summary_card").
              slice(1,10).
              transition('fade down')
            if ($(this).attr("openflag")=="1"){
              $(this).text("候補を隠す")
              $(this).attr("openflag",0)
            }else{
              $(this).text("候補を表示")
              $(this).attr("openflag",1)
            }
           })
        }
        if (i!=0){
          card.hide()
        }

         $("#summary_board").append(card)
      
      })

      if(false){
      $("#send").text(JSON.stringify(data));
      // デバグ用のテーブル描画
      $("#ret").text(JSON.stringify(json_data));
      $("#result-table > table").remove();
      var tableJQ = $('<table class="ui large table">');
      var thead = $("<thead><tr></tr></thead>").appendTo(tableJQ);
      $.each(json_data["members"], function (i, members) {
        $("<th>" + members + "</th>").appendTo(thead);
      })
      $("<th>合計</th>").appendTo(thead);
      $("<th>差額</th>").appendTo(thead);

      var tbody = $("<tbody></tbody>").appendTo(tableJQ);

      $.each(json_data["candidacy"]["coefs"], function (i, e) {
        var tbody_one = $("<tr></tr>")
        $.each(e, function (i, v) {
          $("<td>" + v + "</td>").appendTo(tbody_one);
        })
        var sum = dot(e, members)
        $("<td>" + sum + "</td>").appendTo(tbody_one);
        $("<td>" + String(-json_data["charge"] + sum) + "</td>").appendTo(tbody_one);
        tbody_one.appendTo(tbody);
      })
      $("#result-table").append(tableJQ);
    }
    $("#error").hide()

    },
    error: function () {
      $("#error").show()
      console.log("a")
    },
    complete: function () {
      $("#summary_board").removeClass("loading")
    }
  });
});


$(".cost_stacker > span > div").each(function(i){
  if ($(this).attr("data-num")){
    var target=$(".bar[data-num="+$(this).attr("data-num")+"]")
    $(this)
    .popup({
      position : 'top center',
      target   : target,
      content  : target.attr("data-content")
    });
  }
})


$('.ui.accordion').accordion();

</script>